/*! For license information please see wysiwyg4all.js.LICENSE.txt */
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Wysiwyg4All:()=>h});const n={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",goldenrod:"#daa520",gold:"#ffd700",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavenderblush:"#fff0f5",lavender:"#e6e6fa",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};class i{constructor(e="#4848db",t=!0){this.fineTuned=t;let n=this._colorType(e);this.type=n.type,this.color=n.color}_colorType(e=this.color,t=!0){let i,s;try{if(!e)throw"invalid color";if("object"==typeof e&&e.string&&(e=e.string),"string"!=typeof e)throw"invalid color";if((e=e.toLowerCase())===this.color)return{type:this.type,color:this.color};if(n[e])return{type:"hex",color:n[e]};if(i=e.match(/^(rgba?|rgb?|hsla?|#)/g),Array.isArray(i)){if("#"===i[0]){if(4===e.length&&(e=e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]),!/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e))throw"invalid hex";s="hex"}else")"===e[e.length-1]&&(s=i[0]);return{type:s,color:e}}}catch(n){if(t)throw n+":"+e}return{}}_extractDigit(e=this.color){let{type:t=this.type,color:n=this.color}=this._colorType(e);"hex"===t&&(n=this.rgba(1,n).string);const i=[];for(const e of n.match(/\d+(\.\d+)?/g))i.push(parseFloat(e));return i.length<4&&i.push(1),i}getAlpha(e=this.color){let t=this._extractDigit(e);return t&&t[3]||1}colorScheme(e=this.color,t=!1){let n,i,s={black:.88,white:1},o={"--background":t?"#121212":"#f7f7f7","--content":t?"#2b2b2b":"#ffffff"},r=this.isHighLuminance(o["--content"]),l=(()=>{if(e&&"object"==typeof e){if(e["--button"])return n=e["--button"],n;for(let t of e)if(t.includes("focus"))return n=e[t],n}return n=e,i=this.matchLuminance(e,o["--content"],r?1.5:4.5),t?i:e})(),a=1,h=(()=>{let e=this.analogous(n,30),t=this.hsla(1,n).h,i=this.hsla(1,e[0]).h,s=this.hsla(1,e[1]).h;return t+30>360&&(i+=360),t-30<0&&(s=360-s),Math.abs(t-i)>Math.abs(t-s)?(a=-1,e[1]):e[0]})(),c=this.matchLuminance(this.complementary(l,60*a),o["--background"],3.1),d={"--placeholder":t?"rgba(255, 255, 255, 0.55)":"rgba(0, 0, 0, 0.44)"},f=t?this.matchLuminance(h,o["--background"],4.5):h,u=this.matchLuminance(h,o["--background"],4.5);for(let e in o)o[e+"-text"]=this.textColor(s,o[e]),o[e+"-focus"]=e.includes("--background")?f:l,o[e+"-text_focus"]=e.includes("--background")?u:this.matchLuminance(t?l:i,o[e],1.66),o[e+"-focus-text"]=this.textColor(1,e.includes("--background")?f:l);if(o["--focus"]=n,o["--focus-text"]=this.textColor(1,n),o["--saturate"]=i,o["--saturate-text"]=this.textColor(1,i),Object.assign(o,{"--complementary":c,"--complementary-text":this.textColor(1,c),"--analogous":h,"--analogous-text":this.textColor(1,h),"--alert":"tomato","--success":"limegreen","--button":l,"--text-button":t?this.matchLuminance(i,o["--content"],7):this.contrastRatio(o["--content"],i)<4.5?"inherit":i,"--button-text":this.textColor(1,l)}),e&&"object"==typeof e){for(let t of e)if("-"!==t[0])throw"invalid color scheme";Object.assign(o,e)}let g=Object.assign(o,d);return Object.keys(g).sort().reduce(((e,t)=>(e[t]=g[t],e)),{})}matchLuminance(e,t=this.color,n,i,s){let{color:o}=this._colorType(t),r=this._colorType(e).color;if(n){let e=r,t=this.contrastRatio(e,o);if(t<n){let r=i||this.isHighLuminance(o)?-1:1,l=100;for(;t<n&&l--;){let n;switch(s){case"brightness":n=this.adjustBrightness(1*r,e);break;case"luminance":n=this.adjustLuminance(1*r,e);break;default:n=this.adjustBrightness(1*r,{legacy:!0,color:e})}if(e===n)break;e=n,t=this.contrastRatio(e,o)}}return this.hex(e)}{let e=this._luminance(o),t=this._luminance(r);if(Math.abs(t-e)<.01)return r;let n=this.hex(r),i=(e,t)=>e<t?1:-1,l=i(t,e);for(;Math.abs(t-e)>.01&&l===i(t,e);){let o;switch(s){case"saturation":o=this.adjustBrightness(l,{color:n,legacy:!0});break;case"luminance":o=this.adjustLuminance(l,n);break;default:o=this.adjustBrightness(l,n)}let r=this._luminance(o);if(r===t||l!==i(r,e))break;t=r,n=o}return this.hex(n)}}analogous(e=this.color,t=30){let{color:n}=this._colorType(e),i=(e,t)=>{let n=e+t;return n<0?360+n:n>360?n-360:n},s=this.hsla(this.getAlpha(n),n),o="hsla("+i(s.h,t)+", "+s.s+"%, "+s.l+"%, "+s.a+")",r="hsla("+i(s.h,-t)+", "+s.s+"%, "+s.l+"%, "+s.a+")";return[this.matchLuminance(o,n),this.matchLuminance(r,n)]}complementary(e=this.color,t=0){let{color:n}=this._colorType(e),i=this.hsla(this.getAlpha(n),n);return i.h<180?i.h+=180:i.h-=180,i.h+=t,i.h=i.h>360?i.h-360:i.h<0?360-i.h:i.h,this.hex(this._toString(i))}isHighLuminance(e=this.color,t=this.fineTuned){const{r:n,g:i,b:s}=this.rgba(1,this._colorType(e).color);return(t?(235*n+733.75*i+114*s)/1e3:(299*n+587*i+114*s)/1e3)>=(t?188:128)}_luminance(e=this.color){let t=this.rgba(1,e),n=[t.r,t.g,t.b].map((function(e){return(e/=255)<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4)}));return.2126*n[0]+.7152*n[1]+.0722*n[2]}_toString(e){let t=(e,t=100)=>"number"==typeof e?e:t;if("string"==typeof e)return e;if(e.hasOwnProperty("h"))return"hsla("+(e.h||0)+", "+t(e.s)+"%, "+t(e.l)+"%, "+t(e.a,1)+")";if(e.hasOwnProperty("r"))return"rgba("+t(e.r)+", "+t(e.g)+", "+t(e.b)+", "+t(e.a,1)+")";throw e}contrastRatio(e,t=this.color){let n=this._luminance(t)+.05,i=this._luminance(e)+.05;return n>i?n/i:i/n}textColor(e=1,t=this.color){"string"==typeof t&&(t={color:t});let n,i,{color:s=this.color,fineTuned:o=!0}=t;if(s=this._colorType(s).color,this.getAlpha(s)<.5)return"";if("number"==typeof e&&e<1)n=e,i=e;else if(e&&"object"==typeof e)for(let t of["black","white"]){let s=e[t];"number"==typeof s&&s<1&&("black"===t?n=s:"white"===t&&(i=s))}const r=e=>"number"==typeof e?e<1&&e>0?e:e>1?1:0:1;return this.isHighLuminance(s,o)?n?`rgba(0, 0, 0, ${r(n)})`:"black":i?`rgba(255, 255, 255, ${r(i)})`:"white"}hsla(e,t=this.color){const{type:n=this.type,color:i=this.color}=this._colorType(t),s=(e,t,n)=>{e/=255,t/=255,n/=255;let i=Math.min(e,t,n),s=Math.max(e,t,n),o=s-i,r=0,l=0,a=0;return r=0===o?0:s===e?(t-n)/o%6:s===t?(n-e)/o+2:(e-t)/o+4,r=Math.round(60*r),r<0&&(r+=360),a=(s+i)/2,l=0===o?0:o/(1-Math.abs(2*a-1)),l=+(100*l).toFixed(1),a=+(100*a).toFixed(1),{h:r,s:l,l:a}};if("hex"===n){e="number"==typeof e?e:1;const t=this.rgba(e,i),{r:n,g:o,b:r,a:l}=t,{h:a,s:h,l:c}=s(n,o,r);return{r:n,g:o,b:r,a:l,h:a,s:h,l:c,string:this._toString({h:a,s:h,l:c,a:e})}}{const t=this._extractDigit(i);if(e="number"==typeof e?e:t[3]||1,n.includes("hsl")){const{r:n,g:s,b:o,a:r}=this.rgba(e,i);return{r:n,g:s,b:o,a:r,h:t[0],s:t[1],l:t[2],string:this._toString({h:t[0],s:t[1],l:t[2],a:r})}}if(n.includes("rgb")){const n={r:t[0],g:t[1],b:t[2],a:e},{h:i,s:o,l:r}=s(n.r,n.g,n.b);return Object.assign(n,{r:n.r,g:n.g,b:n.b,h:i,s:o,l:r,a:n.a,string:this._toString({h:i,s:o,l:r,a:n.a})})}}}hex(e=this.color){const{type:t=this.type,color:n=this.color}=this._colorType(e);if(t.includes("rgb")||t.includes("hsl")){const e=this.rgba(1,n);return"#"+((1<<24)+(e.r<<16)+(e.g<<8)+e.b).toString(16).slice(1)}return n}rgba(e,t=this.color){const{type:n=this.type,color:i=this.color}=this._colorType(t);if("hex"===n){const t=i;let n={r:null,g:null,b:null},s=t.match(/[a-fA-F0-9]{2}/g);4===t.length&&(s=t.match(/[a-fA-F0-9]{1}/g),s=s.map((e=>""+e+e)));let o=0;for(const e in n)n[e]=parseInt(s[o],16),o++;const r="number"==typeof e?e:1;let{r:l,g:a,b:h}=n;return{...n,a:r,string:this._toString({r:+l,g:+a,b:+h,a:r})}}{const t=this._extractDigit(i),s="number"==typeof e?e:t[3]||1;if(n.includes("rgb")){let e={r:t[0],g:t[1],b:t[2],a:s};return Object.assign({string:this._toString(e)},e)}if(n.includes("hsl")){let e=t[0],n=t[1],i=t[2];n/=100,i/=100;let o=(1-Math.abs(2*i-1))*n,r=o*(1-Math.abs(e/60%2-1)),l=i-o/2,a=0,h=0,c=0;return 0<=e&&e<60?(a=o,h=r,c=0):60<=e&&e<120?(a=r,h=o,c=0):120<=e&&e<180?(a=0,h=o,c=r):180<=e&&e<240?(a=0,h=r,c=o):240<=e&&e<300?(a=r,h=0,c=o):300<=e&&e<360&&(a=o,h=0,c=r),a=Math.round(255*(a+l)),h=Math.round(255*(h+l)),c=Math.round(255*(c+l)),{r:a,g:h,b:c,a:s,string:this._toString({r:a,g:h,b:c,a:s})}}}}adjustBrightness(e=0,t=this.color){let n,i=!1;if("string"==typeof t?n=t||this.color:(n=t.color||this.color,i=t.legacy||!1),i){let{color:t}=this._colorType(n),i=this.hsla(this.getAlpha(t),t),s=(e,t=100)=>e>t?t:e<0?0:e;return i.s+=(e>0?100-i.s:i.s)/100*e,i.s=s(i.s),i.l+=(e>0?100-i.l:i.l)/100*e,i.l=s(i.l),this._toString(i)}let{type:s=this.type,color:o=this.color}=this._colorType(n);if(0===e)return o;const r="hex"===s?1:this._extractDigit(o)[3]||1,l=this.rgba(r,o);let a={r:0-l.r,g:0-l.g,b:0-l.b};e>0&&Object.keys(a).map((function(e){a[e]=255-l[e]})),["r","g","b"].map((function(t){l[t]+=parseInt(a[t]/100*Math.abs(e))}));const h="rgb("+l.r+", "+l.g+", "+l.b+")";return"hex"===s?this.hex(h):s.includes("rgb")?this.rgba(l.a,h).string:s.includes("hsl")?this.hsla(l.a,h).string:void 0}adjustLuminance(e=0,t=this.color){let{color:n}=this._colorType(t),i=this.hsla(this.getAlpha(n),n);return i.l+=(e>0?100-i.l:i.l)/100*e,i.l=((e,t=100)=>e>t?t:e<0?0:e)(i.l),this._toString(i)}adjustSaturation(e=0,t=this.color){let{color:n}=this._colorType(t),i=this.hsla(this.getAlpha(n),n);return i.s+=(e>0?100-i.s:i.s)/100*e,i.s=((e,t=100)=>e>t?t:e<0?0:e)(i.s),this._toString(i)}}function s(e,t){let n=(e,t=!1)=>Array.isArray(e)?e:"string"==typeof e&&e||"number"==typeof e||"boolean"==typeof e||t&&"object"==typeof e?[e]:[],i=!!e,{node:s=null,position:r=!0}=e||{},a=window.getSelection();if(!a)return null;let h=null;try{h=a.getRangeAt(0)}catch(e){i&&(h=document.createRange())}if(i){s=n(s,!0),r=n(r,!0);for(let e of r)if("number"!=typeof e&&"boolean"!=typeof e&&null!==e)throw"INVALID_POSITION";for(let e of s)if(!(e instanceof Node)&&null!==e){if(!1===e)return;throw"INVALID_NODE"}const e=(e,t)=>{if(e instanceof Node){if(1===e.nodeType){if("boolean"==typeof t)for(;!1===t?e.lastChild:e.firstChild;)e=!1===t?e.lastChild:e.firstChild;else if("number"==typeof t){let n=0;if(o((i=>{if(3===i.nodeType&&i.textContent.length){let s=i.textContent.length;if("false"===i.parentNode.getAttribute("contenteditable"))return t-(n+s)>=0?(n+=s,i):(t=s,"BREAK");if(e=i,!(t-(n+s)>=0))return t-=n,"BREAK";n+=s}return i}),{node:e}),1===e.nodeType){let n=document.createTextNode("​");e.insertBefore(n,e.childNodes[0]),e=n,t=0}}"BR"===e.nodeName&&e.parentNode.childNodes.length>1&&(e=e.previousSibling||e)}return t="boolean"==typeof t?t?0:e.textContent.length:t>e.textContent.length?e.textContent.length:t,{node:e,position:t}}};let t,i=!1,l=(s[0]=null===s[0]?h.startContainer:s[0],r[0]=null===r[0]?h.startOffset:r[0],e(s[0],r[0]));h.setStart(l.node,l.position),r.length>1?t=e((null===s[1]?h.endContainer:s[1])||s[0],null===r[1]?h.endOffset:r[1]):(t=l,i=!0),h.setEnd(t.node,t.position),i&&h.collapse(!0),a.removeAllRanges(),a.addRange(h)}if(t&&h){let e,n;for(let i of t){let t=3===h.endContainer.nodeType?h.endContainer.parentNode:h.endContainer,s=3===h.startContainer.nodeType?h.startContainer.parentNode:h.startContainer;if(!e&&s.closest(i)&&(e=l(s,s.closest(i))),!n&&t.closest(i)&&(n=l(t,t.closest(i))),e&&n)break}h.startLine=e,h.endLine=n}return h}function o(e,t){const{parentNode:n,node:i,startFromEldestChild:s,startNode:o}=t;if(s&&!n)throw new Error("Need parentNode to crawl up single child");if(!i||!(i instanceof Node||i?.commonAncestorContainer))throw new Error("No node to crawl");let a,h,c,d=[],f=!!i.commonAncestorContainer,u=null;if(n&&n instanceof Node&&1===n?.nodeType&&(a=n),f?(u=i.commonAncestorContainer,u=3===u.nodeType&&u.parentNode||u):u=i,s&&(u=l(u,n,!0)),a)for(;3===u.nodeType||u!==a&&u.parentNode&&u.parentNode!==a;)u=u.parentNode;if(3===u.nodeType)return d.push(e(u)),{nodes:d,commonContainer:u};1===u.nodeType&&(c=u.id||(h=r("crawl"),u.id=h,h));let g=(o instanceof Node?o:null)||(f?i.startContainer:u.childNodes[0]),m=f?i.endContainer:u.childNodes[u.childNodes.length?u.childNodes.length-1:0],p=e=>!!(e&&e instanceof Node)&&(1!==e.nodeType||e.id!==c&&e.parentNode?.closest("#"+c));for(;p(g);)if(1===g.nodeType&&g.childNodes.length)g=g.childNodes[0];else if(g){if("function"==typeof e&&(g=e(g)),"BREAK"===g||!p(g))break;if(d.push(g),g===m)break;let t=!1;for(;!g.nextSibling&&g.parentNode&&p(g.parentNode);)if(g=g.parentNode,g){if("function"==typeof e&&(g=e(g)),"BREAK"===g||!p(g)){t=!0;break}g&&d.push(g)}if(t)break;g=g.nextSibling}return h&&u.removeAttribute("id"),{node:d,commonContainer:u}}function r(e){let t=12,n="";"number"==typeof e?t=e:"string"==typeof e&&(n=`${e}_`);let i="";for(let e=0;e<t-6;e++)i+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".charAt(Math.floor(51*Math.random()));return n+(new Date).getTime().toString().substring(7,13)+i}function l(e,t,n=!1,i){if(i=i||(e=>e),!(t instanceof Node)||3===t?.nodeType)throw new Error("invalid wrapper node");let s,o=t.id||(s=r("eldest"),t.id=s,s);function l(e){if(!e||3===e.nodeType)return!1;let t=e?.children?.length;return 0===t||(()=>{let t=e.childNodes.length,n=0,i=!1;for(;t--;){let s=e.childNodes[t];if(3===s.nodeType&&s.textContent.length>0&&"​"!==s.textContent?i=!0:1===s.nodeType&&"BR"!==s.nodeName&&n++,n>1&&!i||n&&i)return!1}return!0})()}for(;e?.id!==o&&e.parentNode&&e.parentNode.closest("#"+o)&&e.parentNode.id!==o&&(!n||l(e?.parentNode));){let t=i(e.parentNode);if(!t||"BREAK"===t)break;e=t}return s&&t.removeAttribute("id"),e}function a(e){let t=12,n="";"number"==typeof e?t=e:"string"==typeof e&&(n=`${e}_`);let i="";for(let e=0;e<t-6;e++)i+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".charAt(Math.floor(51*Math.random()));return n+(new Date).getTime().toString().substring(7,13)+i}class h{constructor(e){let{elementId:t="",editable:n=!0,placeholder:s="",spellcheck:o=!1,highlightColor:r="teal",html:l="",callback:a,fontSize:h={desktop:"18px",tablet:"16px",phone:"14px",h1:4.2,h2:3.56,h3:2.92,h4:2.28,h5:1.64,h6:1.15,small:.8},lastLineBlank:c=!1,hashtag:d=!1,urllink:f=!1,logMutation:u=!1,logExecution:g=!1}=e;if(this.hashtag=d,this.urllink=f,this.logMutation=u,this.logExecution=g,this.fontSizeCssVariable={},"number"==typeof h)this.fontSizeCssVariable={"--wysiwyg-font-desktop":`${h}`,"--wysiwyg-font-tablet":`${h}`,"--wysiwyg-font-phone":`${h}`};else if("object"==typeof h&&Object.keys(h).length){let e,t=["desktop","tablet","phone"];for(let n of t)h[n]&&(e=h[n],"number"==typeof e&&(e=`${e}px`)),this.fontSizeCssVariable[`--wysiwyg-font-${n}`]=`${e}`}if(!t||"string"!=typeof t)throw new Error("The wysiwyg element should have an ID");if(t="#"===t[0]?t.substring(1):t,this.html=l,this.elementId="#"===t[0]?t.substring(1):t,this.placeholder=s,this.spellcheck=o,this.lastLineBlank=c,"string"==typeof r&&(r=new i(r).color),this.colorScheme=r,this.callback=a||null,this.image_array=[],this.hashtag_array=[],this.urllink_array=[],this.custom_array=[],this.blockElement_queryArray=["HR","BLOCKQUOTE","UL","OL","._media_","._custom_"],this.specialTextElement_queryArray=["._hashtag_","._urllink_"],this.restrictedElement_queryArray=["._media_","._custom_"],this.textAreaElement_queryArray=["BLOCKQUOTE","LI"],this.textBlockElement_queryArray=["P","LI","TD","TH"],this.ceilingElement_queryArray=["UL","OL","BLOCKQUOTE",`#${t}`,"TD","TH"],this.unSelectable_queryArray=["._media_","._custom_","._hashtag_","._urllink_","HR"],this.styleAllowedElement_queryArray=["._color",`#${t}`,"._hashtag_","._urllink_","TD","TH"],this.alignClass=["_alignCenter_","_alignRight_"],this.hashtag_flag=!1,this.urllink_flag=!1,this.range_backup=null,this.commandTracker={},this.range=null,this.isRangeDirectionForward=!0,this.insertTabPending_tabString="",this.removeSandwichedLine_array=[],this.lastKey=null,this.element=document.getElementById(this.elementId),!this.element)throw`element #${this.elementId} is null`;this.element.innerHTML="",this.cssVariable=(new i).colorScheme(this.colorScheme),Object.assign(this.cssVariable,this.fontSizeCssVariable);for(const e in this.cssVariable)this.element.style.setProperty(e,this.cssVariable[e]);this.elementComputedStyle=window.getComputedStyle(this.element),this.defaultFontColor=new i(this.cssVariable["--content-text"]).hex(),this.highlightColor=new i(this.cssVariable["--content-focus"]).hex(),this.element.classList.contains("_wysiwyg4all")||this.element.classList.add("_wysiwyg4all"),this.setPlaceholder(this.placeholder),this.setSpellcheck(this.spellcheck);let m=this.elementComputedStyle.paddingBottom,p=this.elementComputedStyle.paddingTop,y=this.elementComputedStyle.borderTopWidth,_=this.elementComputedStyle.borderBottomWidth;this.element.style.minHeight=`calc(${m} + ${p} + ${y} + ${_} + 1.6em)`;const b={h1:["_h1","fontSize",["_small","_h2","_h3","_h4","_h5","_h6"]],h2:["_h2","fontSize",["_small","_h1","_h3","_h4","_h5","_h6"]],h3:["_h3","fontSize",["_small","_h1","_h2","_h4","_h5","_h6"]],h4:["_h4","fontSize",["_small","_h1","_h2","_h3","_h5","_h6"]],h5:["_h5","fontSize",["_small","_h1","_h2","_h3","_h4","_h6"]],h6:["_h6","fontSize",["_small","_h1","_h2","_h3","_h4","_h5"]],italic:["_i","fontStyle"],small:["_small","fontSize",["_h1","_h2","_h3","_h4","_h5","_h6","_b"]],bold:["_b","fontWeight",["_small"]],underline:["_u","textDecoration",["_del"]],strike:["_del","textDecoration",["_u"]],color:["_color","color"]},E={h1:h.h1||4.2,h2:h.h2||3.56,h3:h.h3||2.92,h4:h.h4||2.28,h5:h.h5||1.64,h6:h.h6||1.15,small:h.small||.8};for(const[e,t]of Object.entries(E))if("number"==typeof t)this.element.style.setProperty(`--wysiwyg-${e}`,`calc(var(--wysiwyg-font) * ${t})`);else if("string"==typeof t)if(t.includes("px"))this.element.style.setProperty(`--wysiwyg-${e}`,t);else if(t.includes("em")||t.includes("rem")){let n=parseFloat(t);n>0&&this.element.style.setProperty(`--wysiwyg-${e}`,`calc(var(--wysiwyg-font) * ${n})`)}this.styleTagOfCommand={},this.counterTagOf={},this.cssPropertyOf={},this.cssPropertyChecker={textDecoration:e=>e.includes("underline")?"underline":!!e.includes("line-through")&&"strike",fontSize:e=>{let t=parseFloat(this.elementComputedStyle.fontSize),n=parseFloat(e);for(let i in E){let s=E[i];if("number"==typeof s){let e=t*s;if(e+.01>n&&e-.01<n)return i}else if("string"==typeof s)if(s.includes("px")){if(e===s)return i}else if(s.includes("em")||s.includes("rem")){let e=parseFloat(s);if(e>0){let s=t*e;if(s+.01>n&&s-.01<n)return i}}}return!1},fontStyle:e=>!!e.includes("italic")&&"italic"};for(let e in b)this.commandTracker[e]=!1,this.styleTagOfCommand[e]=b[e][0],this.cssPropertyOf[b[e][0]]=b[e][1],this.cssPropertyChecker.hasOwnProperty(b[e][1])||(this.cssPropertyChecker[b[e][1]]=e),b[e][2]&&(this.counterTagOf[b[e][0]]=b[e][2]);this.loadHTML(this.html,n).catch((e=>{throw e}))}_wrapNode(e,t,n=!1){if(this.logExecution&&console.log("_wrapNode()",{node:e,wrapper:t,appendWhole:n}),!(e instanceof Node))return;if(!e.parentNode)throw new Error("can't unwrap document fragment");let i=window.getSelection().getRangeAt(0),r=null,l=i.startOffset,a=null,h=i.endOffset;const c=e=>{i.startContainer===e&&(r=e),i.endContainer===e&&(a=e)};if(1===e.nodeType?o((e=>(c(e),e)),{node:e}):c(e),t&&e.parentNode.insertBefore(t,e),3===e.nodeType){if(!t)throw new Error("no wrapper for text content");t.append(e)}else if(n)t.append(e);else for(;e.childNodes[0];){let n=e.childNodes[0];t?t.append(n):e.parentNode.insertBefore(n,e)}let d;if(1===e.nodeType&&!n){let n=(t||e).parentNode;d=e.previousSibling,n.removeChild(e)}return(d||e).textContent&&(r||a)&&(i=s(r&&r===a&&l===h?{node:d||e,position:l}:{node:[r,a],position:[l,h]},this.ceilingElement_queryArray)),this.range=i,{node:d||e,range:i}}_getStartEndLine(e=this.range,t=this.element,n=!1){if(this.logExecution&&console.log("_getStartEndLine()",{range:e,element:t}),!e)return[null,null,null];let i=l(e.startContainer,t),s=l(e.endContainer,t),o=[];if(n){let e=i.nextSibling;for(;e&&e!==s;)1===e.nodeType&&this.blockElement_queryArray.some((t=>e.matches(this._classNameToQuery(t))))&&o.push(e),e=e.nextSibling}return[i,s,o]}_isThereContentEditableOverMyHead(e,t=this.element){if(e&&e!==this.element){let t=e;for(;t&&this.element!==t;){if("true"===t.getAttribute("contenteditable"))return!0;t=t.parentNode}}return!1}_normalizeBrowserQuirks(){navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&o((e=>("BR"!==e.nodeName||e.nextSibling&&"BR"!==e.nextSibling.nodeName||e.remove(),e)),{node:this.element}),navigator.userAgent.toLowerCase().indexOf("safari")}_isSelectionTrespassRestrictedRange(e=this.range,t=this.element){if(!e)return this.logExecution&&console.log("_isSelectionTrespassRestrictedRange():true",{range:e,element:t}),!0;let{commonAncestorContainer:n,startContainer:i,endContainer:s,startLine:o,endLine:r,inBetween:l}=e,a=this.restrictedElement_queryArray;if(o===r){n=3===n.nodeType?n.parentNode:n;for(let e of a)if(n.closest(this._classNameToQuery(e))&&!this._isThereContentEditableOverMyHead(n,t))return!0}else if(l?.length)for(let e=0;e<l.length;e++)for(let t of a)if(l[e].closest(this._classNameToQuery(t))&&!this._isThereContentEditableOverMyHead(l[e]))return!0;return!1}_classNameToQuery(e){return this.logExecution&&console.log("_classNameToQuery()",{q:e}),e.includes("_stop")&&"."!==e[0]||"_"===e[0]?"."+e:e}_createEmptyParagraph(e){this.logExecution&&console.log("_createEmptyParagraph()",{append:e});let t=document.createElement("p");return e&&"string"==typeof e&&(e=document.createTextNode(e)),t.append(e||document.createTextNode("")),e||t.append(document.createElement("br")),t}_trackStyle(e,t){this.logExecution&&console.log("_trackStyle()",{n:e,cls:t});let n={},s=window.getComputedStyle(e);for(let t of this.alignClass)e.closest("."+t)&&(n[t.substring(1,t.length-1)]=!0);let o=o=>{let r=this.cssPropertyChecker[o];if("function"==typeof r){if(r=r(s[o]),r){if(t)return r;n[r]=!0}}else if("color"===o&&s[o]){let e="#"===s[o][0]?s[o]:new i(s[o]).hex();if(e!==this.defaultFontColor){if(t)return e;n[r]=e}}else if(s[o]!==this.elementComputedStyle[o]&&this._isTextElement(e)){if(t)return!0;n[r]=!0}return!1};if(t)return o(this.cssPropertyOf[t.toLowerCase()]);for(let e in this.cssPropertyChecker)o(e);return n}_lastLineBlank(e){if(this.logExecution&&console.log("_lastLineBlank()",{force:e}),this.lastLineBlank||e){let e=this.element.lastChild;("P"!==e.nodeName||"P"===e.nodeName&&e.textContent&&"​"!==e.textContent)&&this.element.append(this._createEmptyParagraph())}}_selectionchange=()=>{let e=window.getSelection(),t=3===e.anchorNode?.nodeType?e.anchorNode.parentNode:e.anchorNode,n=3===e.focusNode?.nodeType?e.focusNode.parentNode:e.focusNode;if(!t.closest(`#${this.elementId}`)||!n.closest(`#${this.elementId}`))return this.range=null,void(this.commandTracker={});{let e=this.element.lastChild;e?this.range=s(null):(e=this._createEmptyParagraph(),this.element.appendChild(e),this.range=s({node:e,position:!0},this.ceilingElement_queryArray))}let i={};for(let e in this.styleTagOfCommand)i[e]=!1;let[r,l,a]=this._getStartEndLine(this.range,this.element,!0);this.range.startLine=r,this.range.endLine=l,this.range.inBetween=a;let h,c=this.restrictedElement_queryArray.concat(this.specialTextElement_queryArray);if(!o((e=>{(1===e.nodeType&&e.closest("blockquote")||3===e.nodeType&&e.parentNode.closest("blockquote"))&&(i.quote=!0);for(let t of c)if(3===e.nodeType?e.parentNode.closest(t):1===e.nodeType?e.closest(t):!(e instanceof Node))return e;if(3===e.nodeType||"BR"===e.nodeName||1===e.nodeType&&1===e.childNodes.length&&("BR"===e.childNodes[0].nodeName||3===e.childNodes[0].nodeType)){let t=3===e.nodeType||"BR"===e.nodeName?e.parentNode:e,n=this._trackStyle(t);for(let e in n)i[e]=n[e]}return e}),{node:this.range,parentNode:this.element}).node.length){let e=this._trackStyle(this.range.startContainer);for(let t in e)i[t]=e[t]}this.commandTracker=i;let d=this.isRangeDirectionForward?this.range.endContainer:this.range.startContainer;3===d.nodeType?h=this.range.getBoundingClientRect():1===d.nodeType&&(h=d.getBoundingClientRect()),this._callback({commandTracker:i,range:this.range,caratPosition:h}).catch((e=>console.error(e))),this._lastLineBlank()};_setEventListener(e){if(this.logExecution&&console.log("_setEventListener()",{listen:e}),document.removeEventListener("selectionchange",this._selectionchange),this.imgInput=null,this.element&&(this.element.removeEventListener("keydown",this._keydown),this.element.removeEventListener("mousedown",this._normalize),window.removeEventListener("mousedown",this._normalize),this.element.removeEventListener("paste",this._paste),this.element.removeEventListener("keyup",this._keyup)),!e)return;let t=document.createElement("input");for(const[e,n]of Object.entries({id:a("imageInput"),type:"file",accept:"image/gif,image/png,image/jpeg,image/webp",hidden:!0,multiple:!0}))t.setAttribute(e,n);this.imgInput=t,this.imgInput.addEventListener("change",(e=>{this._imageSelected(e).catch((e=>{console.error(e)}))})),this._keydown=function(e){if(!this.range)return;let{startContainer:t,startOffset:n,collapsed:i,startLine:r,endLine:a,inBetween:h}=this.range,c=e.key.toUpperCase(),d=e.shiftKey;if(this.lastKey=c,"ENTER"===c&&e.shiftKey)this.range.endLine.closest("LI")||e.preventDefault();else if(["BACKSPACE","DELETE"].includes(c)){if(!this.element.textContent&&this.element.childNodes.length<=1&&this._isTextElement(this.element.childNodes[0])&&this.element.childNodes[0]===r||0===this.element.childNodes.length)return this.logExecution&&console.log("nothing to delete"),void e.preventDefault();let t=this.range.startContainer;if(this.range.collapsed){this.logExecution&&console.log("range is collapsed");let n=(3===t.nodeType?t.parentNode:t).closest("blockquote");if(n&&n.childNodes[0]===l(t,n)&&0===this.range.startOffset)return this.logExecution&&console.log("block is empty and the cursor is on the first offset position within the blockquote"),e.preventDefault(),void this.command("quote");if(0===this.range.startOffset||1===this.range.startOffset&&("​"===t.textContent[0]||0===t.textContent.length)){let e=this.range.startLine.previousSibling;for(let t of this.unSelectable_queryArray)"."===t[0]?(t=t.substring(1),e&&e.classList.contains(t)&&e.remove()):e&&e.tagName===t&&e.remove()}}if(r!==a)for(let e of this.unSelectable_queryArray)"."===e[0]?(e=e.substring(1),r.classList.contains(e)&&r.remove(),a.classList.contains(e)&&a.remove()):(r.tagName===e&&r.remove(),a.tagName===e&&a.remove())}else if("#"!==c||this.hashtag_flag)if(![":","/","."].includes(c)||this.urllink_flag)if((this.hashtag_flag||this.urllink_flag)&&([" ","ENTER","TAB"].includes(c)||c.includes("ARROW"))&&this._replaceText(),c.includes("ARROW"))this._setArrow(e);else if("TAB"!==c){if("ENTER"===c&&(!i||!t.textContent.includes("​")&&t.textContent||o((e=>(3!==e.nodeType||"​"!==e.textContent&&e.textContent||e.remove(),e)),{node:3===t.nodeType?t.parentNode:t}),"\t"===a.textContent[0]))for(let e of a.textContent){if("\t"!==e)break;this.insertTabPending_tabString+="\t"}}else{e.preventDefault();let l=[];if(!i){let e=r;for(;e&&e!==a;)l.push(e),e=e.nextSibling;l.push(a)}if(d){let e=!1,i=t=>{for(;t.childNodes[0];){for(t=t.childNodes[0];3===t.nodeType&&!t.textContent;)t=t.nextSibling;if(3===t.nodeType&&"\t"===t.textContent[0]){e=!0,t.textContent=t.textContent.substring(1);break}}};if(l.length){for(let e of l)"\t"===e.textContent[0]&&i(e);e&&s({node:[r,a],position:[!0,!1]},this.ceilingElement_queryArray)}else if("\t"===r.textContent[0]){let l=(g=n,(f=r)===(u=t)||o((e=>u===e?"BREAK":(3===e.nodeType&&e.textContent.length&&(g+=e.textContent.length),e)),{node:f}),g-1);l=l<0?0:l,i(r),e&&s({node:r,position:l},this.ceilingElement_queryArray)}}else if(l.length){let e=!1;for(let t of l){e=!0;let n=document.createTextNode("\t");t.insertBefore(n,t.childNodes[0])}e&&s({node:[r,a],position:[!0,!1]},this.ceilingElement_queryArray)}else{let e=document.createTextNode("\t");this.range.insertNode(e),s({node:e,position:!1},this.ceilingElement_queryArray)}}else this.urllink_flag=!0;else this.hashtag_flag=!0;var f,u,g}.bind(this),this._normalize=function(e){e.stopPropagation(),this._isSelectionTrespassRestrictedRange()||(this._normalizeDocument(!0),this.range_backup=this.range.cloneRange(),this._replaceText(!0))}.bind(this),this._paste=function(e){if(e.preventDefault(),!this._isSelectionTrespassRestrictedRange()&&this.range){if(this._isSelectionTrespassRestrictedRange())return;let t=document.createDocumentFragment();t.textContent=e.clipboardData.getData("text/plain").replace(/\n\n/g,"\n"),t.textContent.includes("#")&&(this.hashtag_flag=!0);for(let e of[":","/","."])t.textContent.includes(e),this.urllink_flag=!0;this.range.collapsed||this.range.extractContents(),this.range.insertNode(t)}}.bind(this),this._keyup=function(){if(this.removeSandwichedLine_array.length)for(;this.removeSandwichedLine_array.length;)this.removeSandwichedLine_array.pop().remove()}.bind(this),document.addEventListener("selectionchange",this._selectionchange),this.element.addEventListener("keydown",this._keydown),this.element.addEventListener("mousedown",this._normalize),window.addEventListener("mousedown",this._normalize),this.element.addEventListener("paste",this._paste),this.element.addEventListener("keyup",this._keyup)}destroy(){this.observer.disconnect(),document.removeEventListener("selectionchange",this._selectionchange),this.element.removeEventListener("keydown",this._keydown),this.element.removeEventListener("mousedown",this._normalize),window.removeEventListener("mousedown",this._normalize),this.element.removeEventListener("paste",this._paste),this.element.removeEventListener("keyup",this._keyup)}_observeMutation(e){this.observer&&this.observer.disconnect(),this.observer=null,e&&(this.observer=new MutationObserver((e=>{if(this.logMutation){let t=e.map((e=>({target:e.target.cloneNode(!0),type:e.type,name:e.attributeName,added:(()=>{let t=[];for(let n of e.addedNodes)3===n.nodeType?t.push(n.textContent):t.push(n.cloneNode(!0));return t})(),removed:(()=>{let t=[];for(let n of e.removedNodes)3===n.nodeType?t.push(n.textContent):t.push(n.cloneNode(!0));return t})()}))),n=[];for(let e of t)"childList"!==e.type&&"class"!==e.attributeName||n.push(e);n.length&&this._callback({mutation:n}).catch((e=>e))}for(const t of e)if("attributes"!==t.type){if("childList"===t.type){let e=t.target;if(t.removedNodes.length)for(let n of t.removedNodes){let t=(e,t)=>{if(!t.id)return;let n,i=this[`${e}_array`].length;for(;i--;)if(this[`${e}_array`][i].elementId===t.id){n=this[`${e}_array`].splice(i,1);break}n&&this._callback({removed:{[e]:n}})};if(n?.classList?.contains("_media_")){let e=n.childNodes,i=e.length;for(;i--;){let n=e[i];"IMG"===n.nodeName&&t("image",n)}continue}let i=!1;for(let e of["hashtag","urllink","custom"])if(n?.id?.includes(e)){t(e,n),i=!0;break}i=!1,this._isCeilingElement(e)&&(()=>{let t=e.childNodes.length;if(t)for(;t--;){let n=e.childNodes[t];if(1===n.nodeType||n.textContent)return!1}return!0})()?e.remove():this._isTextBlockElement(e)&&1===e.childNodes.length&&this._isUnSelectableElement(e.childNodes[0])&&e.append(document.createTextNode(""))}if(t.addedNodes.length)for(let n of t.addedNodes){let t=e=>{let t=e?.childNodes?.length,n=[];for(;t--;){let i=e.childNodes[t];"BR"===i.nodeName&&n.push(i)}return n};if(3!==n.nodeType){if(1===n.nodeType){let i=(()=>{let t=n.closest(`#${this.elementId}`)&&n.id!==this.elementId,i=(()=>!!t&&this._isCeilingElement(e))(),s=(()=>{for(let e of this.ceilingElement_queryArray){let t=n.closest(e);if(t)return t}return null})(),o=i?n:t&&(()=>{let e=n;for(;e&&!this._isCeilingElement(e.parentNode);)e=e.parentNode;return e})();return{isWysiwygChild:t,isWysiwygEldestChild:i,isMediaElement:n.closest("._media_"),isBlockQuoteElement:n.closest("blockquote"),isCustomElement:n.closest("._custom_"),isHashtagElement:n.closest("._hashtag_"),isUrlLinkElement:n.closest("._urllink_"),ceiling:s,line:o}})();if(!i.isWysiwygChild)continue;if(i.isCustomElement||i.isMediaElement||i.isHashtagElement||i.isUrlLinkElement){let e=i.isCustomElement||i.isMediaElement||i.isHashtagElement||i.isUrlLinkElement;"true"!==e.getAttribute("contenteditable")&&e.setAttribute("contenteditable","false");continue}if(!(i.isWysiwygEldestChild&&(this._isBlockElement(n)||this._isTextBlockElement(n))||"BR"===n.nodeName||n.classList.length)){this._wrapNode(n);continue}if((()=>{if(this._isStyleAllowedElement(n))return!1;for(let e of this.restrictedElement_queryArray)if(n.closest(e))return!1;return!0})()&&n.removeAttribute("style"),i.isWysiwygEldestChild&&!this._isBlockElement(n)&&!this._isTextBlockElement(n)){"BR"===n.nodeName?n.remove():this._wrapNode(n,document.createElement("p"),!0);continue}if(e.textContent&&"​"!==e.textContent){let i=t(e),s=!1;if(i.length)for(let e of i)e===n&&(s=!0),e.remove();if(s)continue}if(i.isWysiwygEldestChild&&!this._isCeilingElement(n)){if(this.insertTabPending_tabString){let e=document.createTextNode(this.insertTabPending_tabString);i.line.insertBefore(e,i.line.childNodes[0]),this.insertTabPending_tabString="",s({node:e,position:!1},this.ceilingElement_queryArray)}if(!i.line.textContent||"​"===i.line.textContent){let e=!0;o((t=>"BR"===t.nodeName?(e=!1,"BREAK"):t),{node:i.line}),e&&i.line.append(document.createElement("br"))}continue}let r=e=>{let t=this.counterTagOf[e]||[];return t.length&&(t=t.concat(t.map((e=>e+"_stop")))),[e,e.includes("_stop")?e.replace("_stop",""):e+"_stop"].concat(t)},a=[];n.classList.length&&l(n,i.ceiling,!0,(e=>{let t=n.classList.length;for(;t--;)(()=>{let i=r(n.classList[t]);for(let t of i)if(e.classList.contains(t))return!0;return!1})()&&a.push(e);return e}));let h=a.length;for(;h--;)this._wrapNode(a[h]);let c=n.classList.length;for(;c--;){let e=n.classList[c];this._trackStyle(n,e.replace("_stop",""))===this._trackStyle(n.parentNode,e.replace("_stop",""))&&n.classList.remove(e)}n.classList.length||n.removeAttribute("class"),this._isTextBlockElement(e)&&1===e.childNodes.length&&this._isUnSelectableElement(e.childNodes[0])&&e.append(document.createTextNode(""))}}else if(this._isCeilingElement(e))this._wrapNode(n,document.createElement("p"));else if(n.textContent&&"​"!==n.textContent){let n=t(e);if(n.length)for(let e of n)e.remove()}}}}else{const{target:e,attributeName:n}=t;"class"===n&&(!e.parentNode||e.classList.length||this._isTextBlockElement(e)||this._isBlockElement(e)||"P"===e.nodeName||this._wrapNode(e),e.classList.length||e.removeAttribute("class")),"style"!==n||this._isStyleAllowedElement(e)||e.removeAttribute("style")}})),this.observer.observe(this.element,{attributes:!0,childList:!0,subtree:!0}))}_setArrow(e){if(this.logExecution&&console.log("_setArrow",{e}),!this.range||!e?.key)return;let t,n,i,r,a,h,c,d,f,u,g,m=e.key.toUpperCase(),p=e?.shiftKey||!1,y=e?.ctrlKey||e?.metaKey||!1,_=()=>{t=this.range?.endContainer,n=this.range?.endOffset,i=this.range?.startContainer,r=this.range?.startOffset,a=this.range?.collapsed,h=this.range?.startLine,c=this.range?.endLine,d=h===c,f=this.isRangeDirectionForward?c:h,u=this.isRangeDirectionForward?t:i,u=3===u?.nodeType?u?.parentNode:u},b=()=>{let n=this.isRangeDirectionForward?t:i,r=!1;return!a||!n.textContent.includes("​")&&n.textContent||o((t=>{if(3===t.nodeType&&("​"===t.textContent||!t.textContent)){let i=t.nextSibling||t.parentNode,o=this.isRangeDirectionForward?"nextSibling":"previousSibling";if(t===n||(()=>{if(1===n.nodeType){let e=n.childNodes.length;for(;e--;)if(n.childNodes[e]===t)return!0;return!1}})()){let n=i;return 1===n.nodeType&&t.parentNode===n?n[o]&&(r=n[o]):r=i,t.remove(),this.range=s({node:a?r:this.isRangeDirectionForward?[null,r||i]:[r||i,null],position:a?this.isRangeDirectionForward:this.isRangeDirectionForward?[null,r]:[!r,null]},this.ceilingElement_queryArray),_(),e.preventDefault(),"BREAK"}}return t}),{node:n}),!!r},E=()=>{if(!b()&&"inline-block"===window.getComputedStyle(u).display){let e=3===u.nodeType?u.parentNode:u;for(;"inline-block"===window.getComputedStyle(e).display;)e=e.parentNode;let t="UP"===g?"previousSibling":"nextSibling",n=e[t];if(!n){let i=document.createTextNode("");e.parentNode.insertBefore(i,"previousSibling"===t?e:n)}if(e=e[t],e){let t="DOWN"===g;return this.range=s({node:p?this.isRangeDirectionForward?[null,e]:[e,null]:e,position:p?this.isRangeDirectionForward?[null,t]:[t,null]:t},this.ceilingElement_queryArray),_(),!0}}return!1};switch(_(),m){case"ARROWLEFT":g="LEFT";case"ARROWRIGHT":let h;g=g||"RIGHT",(y||a&&p)&&_(),this.range?.startLine===this.range?.endLine&&y&&"RIGHT"===g&&(h=E()),h||b();break;case"ARROWUP":g="UP";case"ARROWDOWN":if(g=g||"DOWN",!a&&!p){e.preventDefault();let o="UP"===g?[i,r]:[t,n];this.range=s({node:o[0],position:o[1]},this.ceilingElement_queryArray);break}if((a||d)&&_(),this.range?.startLine!==this.range?.endLine)break;if(E())break;b();let c=this.range?.startLine!==this.range?.endLine;if(c)break;let u=l(f,this.element),m=u.id!==this.elementId&&this._isCeilingElement(u);if(m&&("UP"===g&&u.firstChild!==f||"DOWN"===g&&u.lastChild!==f))break;let x=[m?u.previousSibling:f.previousSibling,m?u.nextSibling:f.nextSibling];"UP"===g&&x.reverse();let[N,k]=x,T=m?u:k;if(T)if(this._isBlockElement(T)&&!p){e.preventDefault();let t="UP"===g?T.previousSibling:T.nextSibling;if(!t||this._isBlockElement(t)){let e=this._createEmptyParagraph();T.parentNode.insertBefore(e,"UP"===g?T:t),T=e}else T=t;this.range=s({node:T,position:"DOWN"===g},this.ceilingElement_queryArray),p||f.textContent||!this._isBlockElement(N)&&(N||f!==this.element.firstChild)||this.removeSandwichedLine_array.push(f)}else if(!c&&"DOWN"===g){e.preventDefault();let i=0,l=this.isRangeDirectionForward?n:r;o((e=>e===t?"BREAK":(3===e.nodeType&&e.textContent&&(i+=e.textContent.length),e)),{node:f}),i+=l,this.range=s({node:a?k:this.isRangeDirectionForward?[null,k]:[k,null],position:a?i:this.isRangeDirectionForward?[null,i]:[i,null]},this.ceilingElement_queryArray)}}}_append(e,t,n=!1,i){this.logExecution&&console.log("_append",{i:e,insertAfter:t,wrap:n,focusElement:i});let r=l(this.range.commonAncestorContainer,this.element),a=this.range.startLine,h=this.range.endLine,c=["HR","UL","LI","._media_","._custom_"],d=n=>{n===this.element&&(n=this.element.childNodes[this.element.childNodes.length-1]);let i=n.nextSibling;t&&n.parentNode.insertBefore(t,i),n.parentNode.insertBefore(e,t||i),this._isTextElement(n)&&!n.textContent&&this.element.lastChild!==n&&n.remove()};if(n){let t={},n=!1,l=(e,n)=>{!n||t[e]&&!(()=>{for(let e in t)if(t[e]===n)return!1;return!0})()||(t[e]=n)};if(this.range.collapsed){l(e.nodeName,a.closest(e.nodeName));let t=e.classList.length;for(;t--;){let n=e.classList[t];l(n,a.closest("."+n))}}else o((t=>{let i=3===t.nodeType?t.parentNode:t;if(1!==i.nodeType)return n=!0,"BREAK";if(1===t.nodeType)for(let e of c)if(t.nodeName===e||t.closest(e))return n=!0,"BREAK";l(e.nodeName,i.closest(e.nodeName));let s=e.classList.length;for(;s--;){let t=e.classList[s];l(t,i.closest("."+t))}return t===this.range.endContainer?"BREAK":t}),{node:r,startNode:this.range.startContainer});if(n)return;if(Object.keys(t).length)for(let e in t)this._wrapNode(t[e]);else{d(h);let t=this.range.extractContents();if(t.childNodes[0])for(;t.childNodes[0];){let n=t.childNodes[0];n.textContent?e.append(n):n.remove()}else e.append(this._createEmptyParagraph());this.range=s({node:i||e,position:!1},this.ceilingElement_queryArray);let n=e.previousSibling;n&&(n=3===n.nodeType?n.parentNode:n,!this._isTextElement(n)||n.textContent&&"​"!==n.textContent||n.remove())}}else{for(let e of c)h.closest(e)&&(h=h.closest(e));d(h),t&&(this.range=s({node:i||t},this.ceilingElement_queryArray))}}async _callback(e){if("function"==typeof this.callback){let t=this.callback(e)||e;return t instanceof Promise&&(t=await t),t||e}return e}async _imageSelected(e){this.logExecution&&console.log("_imageSelected",{e});let t=e.target.files;const n={image:[]};let i=new FileReader;const s=e=>new Promise((t=>{i.onload=n=>{const{lastModified:i,name:s,size:o,type:r}=e,l=n.target.result;let h=new Image;h.onload=()=>{t({dimension:{width:h.width,height:h.height},lastModified:i,filename:s,fileSize:o,fileType:r,source:l,elementId:a("img")})},h.src=l},i.readAsDataURL(e)}));this.callback({loading:!0});for(let e=0;t.length>e;e++)n.image[e]=await s(t[e]);this.callback({loading:!1}),this.imgInput.value="";let o=await this._callback(n);this.range||this.restoreLastSelection(),this.range&&!(()=>{let e=this.range.commonAncestorContainer;return e=3===e.nodeType?e.parentNode:e,!e.closest("#"+this.elementId)})()||this.element.focus();for(let e of o.image){let t=this._loadImage(e,document.createElement("div"));this._append(t,this._createEmptyParagraph())}}_loadImage(e,t){if(this.logExecution&&console.log("_loadImage",{imageObject:e,wrapper:t}),!(t instanceof Node))throw"image needs _media_ wrapper";return t.classList.contains("_media_")||t.classList.add("_media_"),"false"!==t.getAttribute("contenteditable")&&t.setAttribute("contenteditable","false"),(e=>{let n=e?.element instanceof Node?e.element:null;if(n&&(n.id?e.elementId=n.id:n.id=e.elementId),!n){n=document.createElement("img"),e.element=n;let i="_img_"+e.source.substring(e.source.length-128).replace(/[/:."'\\@#$%\?= \{\}\|&*`!<>+]/g,"");if(n.classList.contains(i)&&n.classList.add(i),Array.isArray(e.class))for(let t of e.class)n.classList.add(t);if("IMG"===n.tagName&&n.setAttribute("src",e.source),"function"==typeof e.onclick&&(n.addEventListener("click",e.onclick),n.classList.add("_hover_")),e.style&&"object"==typeof e.style&&Object.keys(e.style).length)for(let n in e.style)t.style.setProperty(n,e.style[n])}t.setAttribute("contenteditable","false"),t.append(n);let i=!0;for(let t of this.image_array)if(t.elementId===e.elementId){i=!1;break}i&&this.image_array.push(e)})(e),t}_getAnchorOffsetFromLine(e){const t=window.getSelection();if(!t||!t.anchorNode)return 0;let n=t.anchorNode,i=t.anchorOffset;if(!e.contains(n)&&e!==n)return 0;let s=0,o=!1;return function e(t){if(!o){if(t===n)return s+=i,void(o=!0);if(3===t.nodeType)s+=t.textContent.length;else for(let n of t.childNodes)if(e(n),o)break}}(e),s}_getFocusOffsetFromLine(e){const t=window.getSelection();if(!t||!t.focusNode)return 0;let n=t.focusNode,i=t.focusOffset;if(!e.contains(n)&&e!==n)return 0;let s=0,o=!1;return function e(t){if(!o){if(t===n)return s+=i,void(o=!0);if(3===t.nodeType)s+=t.textContent.length;else for(let n of t.childNodes)if(e(n),o)break}}(e),s}_normalizeDocument(e){this.logExecution&&console.log("_normalizeDocument",{normalize:e}),e&&o((e=>{if(3===e.nodeType&&e.textContent.includes("​")){if(e.textContent=e.textContent.replace("​",""),!e.textContent){let t;for(let n of this.ceilingElement_queryArray)if(e.parentNode.closest(n)){t=e.parentNode.closest(n);break}let n=l(e,t,!0),i=n.parentNode;return this._isCeilingElement(i)||n.textContent||this.element.lastChild===n||(i.removeChild(n),e=i),e}}else 1===e.nodeType&&e.normalize();return e}),{node:this.element})}_replaceText(e=!1){this.logExecution&&console.log("_replaceText",{wholeDocument:e});const t=(t,n)=>{if(!this[t])return;let i=this[`${t}_regex`]||null;if(null===i)throw new Error("no regex to process");if("function"!=typeof n)throw new Error("setData should be returning function");let r=e?this.element:this.range?.commonAncestorContainer;if(!r)return;3===r.nodeType&&(r=r.parentNode);let l=(()=>{let e,n=`_${t}_`,s=[],l=[],a=[];if(o((e=>{if(3===e.nodeType&&e.textContent)if(3===e.nextSibling?.nodeType&&e.nextSibling.textContent&&"​"!==e.nextSibling.textContent){let t=e.parentNode;t.normalize(),e=t}else"​"===e.textContent||e.parentNode.closest("."+n)||a.push(e);return e}),{node:r}),a.forEach((e=>{!function(e,t,n){let i,o=e.parentNode,r=e.nextSibling,a=e.ownerDocument;if(t.global)for(;e&&(i=t.exec(e.nodeValue));)t.lastIndex=0,e=h(e,i,n.apply(this,i));else(i=t.exec(e.nodeValue))&&h(e,i,n.apply(this,i));function h(e,t,n){let i=e.nodeValue;e.nodeValue=i.slice(0,t.index),[].concat(c(o,n)).forEach((function(e){let t=o.insertBefore(e,r);s.push(t)}));let l=i.slice(t.index+t[0].length);if(l){let e=a.createTextNode(l);return o.insertBefore(e,r)}}function c(e,t){if(t.map)return t.map((function(t){return c(e,t)}));if("object"==typeof t){let n=a.createElementNS(t.namespaceURI||e.namespaceURI,t.name);if(t.attrs)for(let e in t.attrs)n.setAttribute(e,t.attrs[e]);return t.content&&[].concat(c(n,t.content)).forEach(n.appendChild,n),"string"==typeof t.content&&l.push(t.content),n.contentEditable="false",n}return a.createTextNode(t+"")}}(e,i,(function(e){if(e.length>1)return{name:"span",attrs:{class:`${n} ${n}${e}`},content:e}}))})),s.length)for(let t of s)e=r.ownerDocument.createTextNode(""),t.parentNode.insertBefore(e,t.nextSibling);return{collected:l,element:s,anchorText:e}})(),h=l.element;e||(this.range=s({node:l.anchorText,position:!1},this.ceilingElement_queryArray));let c=[],d=[];if(h[0])for(let e of h){let i=a(t);e.setAttribute("id",i);let s=n(e)||{};s.elementId=e.id,s.element=e,e.removeAttribute("style"),d.push(e.id),c.push(s)}c.length&&this._callback({[t]:c}).then((e=>{for(let n=0;d.length>n;n++)e[t][n].elementId=d[n];if(Array.isArray(e[t])&&e[t].length)for(let n of e[t]){let e=document.getElementById(n.elementId);if(e.setAttribute("id",n.elementId),e.setAttribute("contenteditable","false"),"function"==typeof n.onclick&&(e.addEventListener("click",n.onclick),e.classList.add("_hover_")),n.style&&"object"==typeof n.style&&Object.keys(n.style).length)for(let t in n.style)e.style.setProperty(t,n.style[t]);this[`${t}_array`].push(n)}})).catch((e=>{console.error(e)}))};this.urllink_flag&&t("urllink",(e=>{let t=e.textContent;return e.addEventListener("click",(function(){t.match(/^https?:\/\//i)||(t="http://"+t),window.open(t,"_blank")})),{url:t}})),this.hashtag_flag&&t("hashtag",(e=>{let t=e.textContent;return{tag:"#"===t[0]?t.substring(1):t}})),this.hashtag_flag=!1,this.urllink_flag=!1}_checkElement(e,t,n,i){if(this.logExecution&&console.log("_checkElement",{node:e,chkArr:t,closest:n,exp:i}),e&&1===e.nodeType)for(let s of t)if(n){let t=e.closest(s);if(t){if(i&&i[s]){if("._custom_"!==s)return t.getAttribute(i[s].attr)!==i[s].value&&t;{let t=e,n=!1;if(e!==this.element)for(;t&&this.element!==t||!n;){if(n=t.getAttribute(i[s].attr)===i[s].value,n)return!1;t=t.parentNode}}}return t}}else if("#"===s[0]?e.id===s.substring(1):"."===s[0]?e.classList.contains(s.substring(1)):e.nodeName===s)return!0;return!1}_isUnSelectableElement(e){return this.logExecution&&console.log("_isUnSelectableElement",{node:e}),e=3===e?.nodeType?e.parentNode:e,this._checkElement(e,this.unSelectable_queryArray,!0,{"._custom_":{attr:"contenteditable",value:"true"}})}_isStyleAllowedElement(e){return this.logExecution&&console.log("_isStyleAllowedElement",{node:e}),this._checkElement(e,this.styleAllowedElement_queryArray)}_isCeilingElement(e){return this.logExecution&&console.log("_isCeilingElement",{node:e}),this._checkElement(e,this.ceilingElement_queryArray)}_isBlockElement(e){return this.logExecution&&console.log("_isBlockElement",{node:e}),this._checkElement(e,this.blockElement_queryArray)}_isTextAreaElement(e){return this.logExecution&&console.log("_isTextAreaElement",{node:e}),this._checkElement(e,this.textAreaElement_queryArray)}_isTextBlockElement(e){return this.logExecution&&console.log("_isTextBlockElement",{node:e}),e=3===e?.nodeType?e.parentNode:e,this._checkElement(e,this.textBlockElement_queryArray)}_isSpecialTextElement(e){return this.logExecution&&console.log("_isSpecialTextElement",{node:e}),e=3===e?.nodeType?e.parentNode:e,this._checkElement(e,this.specialTextElement_queryArray)}_isTextElement(e){return this.logExecution&&console.log("_isTextElement",{node:e}),e=3===e?.nodeType?e.parentNode:e,(this._isTextBlockElement(e)||"SPAN"===e.nodeName)&&!this._isSpecialTextElement(e)}command(e){if(!e)return;switch(this.range||this.restoreLastSelection(),e){case"quote":{this.range&&!(()=>{let e=this.range.commonAncestorContainer;return e=3===e.nodeType?e.parentNode:e,!e.closest("#"+this.elementId)})()||this.element.focus();let e=this._createEmptyParagraph(),t=document.createElement("blockquote");return void this._append(t,e,!0)}case"unorderedList":{this.range&&!(()=>{let e=this.range.commonAncestorContainer;return e=3===e.nodeType?e.parentNode:e,!e.closest("#"+this.elementId)})()||this.element.focus();let e=this._createEmptyParagraph(),t=document.createElement("li"),n=document.createElement("ul");return n.append(t),void this._append(n,e,!1,t)}case"orderedList":{this.range&&!(()=>{let e=this.range.commonAncestorContainer;return e=3===e.nodeType?e.parentNode:e,!e.closest("#"+this.elementId)})()||this.element.focus();let e=this._createEmptyParagraph(),t=document.createElement("li"),n=document.createElement("ol");return n.append(t),void this._append(n,e,!1,t)}case"divider":{this.range&&!(()=>{let e=this.range.commonAncestorContainer;return e=3===e.nodeType?e.parentNode:e,!e.closest("#"+this.elementId)})()||this.element.focus();let e=this._createEmptyParagraph(),t=document.createElement("hr");return t.setAttribute("contenteditable","false"),void this._append(t,e,!1)}case"image":return void this.imgInput.click();case"alignLeft":case"alignCenter":case"alignRight":if(!this.range)return;let t=this.range.startLine,n=this.range.endLine,i=[];for(i.push(t);i[i.length-1]!==n;){let e=i[i.length-1].nextSibling;for(;e&&!this._isTextBlockElement(e);){if(this._isCeilingElement(e)&&e.firstChild&&this._isTextBlockElement(e.firstChild)){e=e.firstChild;break}e=e.nextSibling}if(!e&&this._isCeilingElement(i[i.length-1].parentNode)&&(e=i[i.length-1].parentNode.nextSibling),!e)break;i.push(e)}let s=Object.assign({},this.commandTracker);for(let t of i){for(let e of this.alignClass)t.classList.contains(e)&&t.classList.remove(e),s[e.substring(1,e.length-1)]=!1;if("alignLeft"!==e&&!this.commandTracker[e]){for(let n of this.alignClass)n.includes(e)&&t.classList.add(n);s[e]=!0}}return this.commandTracker=s,void this._callback({commandTracker:s,range:this.range}).catch((e=>e))}let t;try{t=new i(e).hex(),e="color"}catch{}if(this.styleTagOfCommand[e]){let n,i=this.styleTagOfCommand[e],r=!1,l=this.counterTagOf[i]?this.counterTagOf[i].map((e=>this._classNameToQuery(e))):[];if(l.length&&(l=l.concat(l.map((e=>e+"_stop")))),i=this._classNameToQuery(i),this.commandTracker[e]){let n;n="color"!==e||t===this.commandTracker[e]||void 0===t&&this.commandTracker[e]===this.cssVariable["--content-text_focus"],n&&(i=this._classNameToQuery(i+"_stop"),r=!0)}"."===i[0]?(n=document.createElement("SPAN"),n.classList.add(i.substring(1))):n=document.createElement(i),t&&!r&&(n.style.color=t);let a=this._isSelectionTrespassRestrictedRange();if(this.range.collapsed){if(a)return;let e=document.createTextNode("");n.append(e),"BR"===this.range.startContainer.nodeName?this.range.startContainer.parentNode.insertBefore(n,this.range.startContainer):this.range.insertNode(n),this.range=s({node:e,position:!1},this.ceilingElement_queryArray)}else{if(a)return void(this.range=s({node:this.range.endContainer,position:this.range.endOffset},this.ceilingElement_queryArray));let e=this.range.extractContents(),t=document.createElement("span");for(;e.childNodes[0];)t.append(e.childNodes[0]);for(o((e=>{let t=a?this._classNameToQuery(a):null,n=3===e.nodeType?e.parentNode:e,i=!(!t||!n.hasOwnProperty("closest"))&&n.closest(t);return 3!==e.nodeType||i||(e.textContent=e.textContent.replaceAll("\t","")),e}),{node:t,startFromEldestChild:!0,parentNode:this.element});t.childNodes[0];)e.append(t.childNodes[0]);let h=[i];if(r){let e=i.replace("_stop","").substring(1);e="_"===e[0]?"."+e:e,h.push(e)}else{let e=i+"_stop";e="."===e[0]?e:"."+e,h.push(e)}h=h.concat(l);let c=e.querySelectorAll(h.join()),d=c.length;if(d)for(;d--;)this._wrapNode(c[d]);let f=[n.cloneNode(!0)];for(;e.childNodes[0];){let t=e.childNodes[0];if(1===t.nodeType&&this._isBlockElement(t)){if(this._isTextAreaElement(t)){for(let e=0;t.childNodes.length>e;e++){let i=t.childNodes[e];if(this._isTextElement(i)){let e=n.cloneNode(!0);for(;i.childNodes[0];)i.childNodes[0].textContent?e.append(i.childNodes[0]):i.childNodes[0].remove();i.append(e)}}if(!t.textContent){t.remove();continue}}let e=document.createDocumentFragment();e.append(t),f.push(e)}else if(1===t.nodeType&&this._isTextBlockElement(t)){let e=n.cloneNode(!0);for(;t.childNodes[0];)e.append(t.childNodes[0]);if(1===e.childNodes.length&&"BR"!==e.childNodes[0].nodeName&&!e.textContent.length){t.remove();continue}t.append(e);let i=document.createDocumentFragment();i.append(t),f.push(i)}else f[f.length-1].append(t)}let u=document.createDocumentFragment();for(let e of f)u.append(e);let g=u.firstChild,m=u.lastChild;if(this._isTextElement(g)&&!g.textContent){let e=g.nextSibling;g.remove(),g=e}if(this._isTextElement(m)&&!g.textContent){let e=m.nextSibling;m.remove(),m=e}this.range.insertNode(u),this.range=s({node:[g,m],position:[!0,!1]},this.ceilingElement_queryArray),g=3===g.nodeType?g.parentNode:g,m=3===m.nodeType?m.parentNode:m;let p=m.nextSibling;!this._isTextElement(p)||p.textContent&&"​"!==p.textContent||p.remove();let y=g.previousSibling;(this._isTextElement(y)&&!y.textContent||"​"===y.textContent)&&y.remove()}}else if("object"==typeof e){let t=document.createElement("div");if(t.classList.add("_custom_"),t.setAttribute("contenteditable",(!!e?.contenteditable).toString()),e.style)for(let n in e.style)t.style[n]=e.style[n];e.elementId=e.elementId||a("custom"),t.id=e.elementId,"string"==typeof e.element?t.innerHTML=e.element:e.element instanceof HTMLElement&&t.append(e.element),t.children.length||(e.insert=!0),this.range||this.element.focus(),this.custom_array.push(e),this._callback({custom:e}).then((n=>{if(e.insert){let e=document.createTextNode("");this.range.insertNode(e),this.range.insertNode(t),this.range=s({node:e,position:!1},this.ceilingElement_queryArray)}else this._append(t,this._createEmptyParagraph(),!1)}))}}restoreLastSelection(){if(this.logExecution&&console.log("restoreLastSelection",{range_backup:this.range_backup}),this.range_backup){this.range=s({node:[this.range_backup.startContainer,this.range_backup.endContainer],position:[this.range_backup.startOffset,this.range_backup.endOffset]},this.ceilingElement_queryArray);let e=window.getSelection(),t=document.createRange();t.setStart(this.range.startContainer,this.range.startOffset),t.setEnd(this.range.endContainer,this.range.endOffset),e.removeAllRanges(),e.addRange(t)}}async loadHTML(e=this.html,t=!1){if("string"!=typeof e)throw new Error("html should be a string");this.setEditable(!1),this.html=e||"";const n=document.createElement("div");n.innerHTML=e;const i=n.querySelectorAll("img"),s=[];if(i.length)for(let e of i){if(e.closest("._media_")){const t=e.getAttribute("src");let n=e.id||a("img");e.setAttribute("id",n),s.push({source:t,elementId:n,element:e})}this.image_array=JSON.parse(JSON.stringify(s))}const o=n.querySelectorAll("._hashtag_"),r=[];if(o.length)for(let e of o){let t,n=e.classList.length,i=e.id||a("hashtag");for(;n--;){let i=e.classList[n];"#"===i.replace("_hashtag_","")[0]&&(t=i.replace("_hashtag_",""))}t="#"===t?.[0]?t.substring(1):t,t&&r.push({tag:t,elementId:i,element:e})}const l=n.querySelectorAll("._urllink_"),h=[];if(l.length)for(let e of l){let t,n=e.id||a("urllink"),i=e.classList.length;for(;i--;){let n=e.classList[i];n.includes("_urllink_").length&&(t=n.replace("_urllink_",""))}t&&h.push({url:t,elementId:n,element:e})}const c=n.querySelectorAll("._custom_"),d=[];if(c.length)for(let e of c){let t=e.id||a("custom");d.push({elementId:t,element:e})}let f=await this._callback({image:s,hashtag:r,urllink:h,custom:d});for(let e in f)if("image"===e){let t=f[e];for(let e of t){const t=n.querySelector("#"+e.elementId).closest("._media_");this._loadImage(e,t)}}else this[e+"_array"]=f[e];for(this.element.innerHTML="";n.childNodes[0];)this.element.append(n.childNodes[0]);t&&this.setEditable(!0)}async export(e){this._normalizeDocument(!0);const t=this.element.cloneNode(!0),{hashtag_array:n,image_array:i,urllink_array:s,custom_array:o}=this;let r="",l="",a={dom:t,urllink:this.urllink?s:void 0,hashtag:this.hashtag?n:void 0,image:i,custom:o};if("function"==typeof e){let t=e(a);a=t instanceof Promise?await t||a:t||a,this.hashtag&&(this.hashtag_array=a.hashtag),this.urllink&&(this.urllink_array=a.urllink),this.image_array=a.image,this.custom_array=a.custom,r=a.title||""}const h=a.dom.querySelectorAll(":scope > *");for(let e=0;e<h.length;e++){let t=h[e];if(t.textContent.length){let e=t.textContent;if(r)l+=`${e}\n`;else{let t,n=/([^\s^.]{2,}[^\s]+[.][^\s^.]{2,})/g,i=e.match(n);if(i){for(let t=0;t<i.length;t++)e=e.replace(i[t].replace(/\.+$/,""),"[§url§]"+t+"[/§url§]");t=e.split(".");for(let e=0;e<t.length;e++)for(let n=0;n<i.length;n++)t[e]=t[e].replace("[§url§]"+n+"[/§url§]",i[n].replace(/\.+$/,""))}else t=e.split(".");r=t[0],r.length>200&&(l+=r.substring(200)+".",r=r.substring(0,200)),t.shift(),e=t.join(".").replace(/\s\s+/g," "),l+=e+" "}}if(t.classList.contains("_media_")){let e=t.childNodes.length;for(;e--;){let n=t.childNodes[e];if("IMG"===n.nodeName)for(const e of this.image_array)if(e.elementId===n.id&&e.source!==n.getAttribute("src")){n.setAttribute("src",e.source);let t=n.classList.length;for(;t--;)if(n.classList[t].includes("_img_")&&n.classList[t].length>5){n.classList.remove(n.classList[t]);let i=e.source.split("/"),s=i[i.length-1],o=s.length-64;const r=i[i.length-1].substring(o>0?s:0);n.classList.add("_img_"+r)}}}}}return{html:a.dom.innerHTML,title:r.trim(),text:l.trim(),urllink:this.urllink?this.urllink_array:void 0,hashtag:this.hashtag?this.hashtag_array:void 0,image:this.image_array,custom:this.custom_array}}setPlaceholder(e){this.logExecution&&console.log("setPlaceholder",{p:e}),this.element&&(e&&"string"==typeof e?this.element.setAttribute("placeholder",e):this.element.removeAttribute("placeholder"))}setSpellcheck(e){this.logExecution&&console.log("setSpellcheck",{bool:e}),this.element&&this.element.setAttribute("spellcheck",e?"on":"off")}setEditable(e){this.logExecution&&console.log("setEditable",{bool:e}),e=!!this.element&&e,this.element&&this.element.setAttribute("contenteditable",e?"true":"false"),this._setEventListener(e),this._observeMutation(e)}}return t})()));
//# sourceMappingURL=wysiwyg4all.js.map